<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doodle Love: Remastered</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* –ö—Ä–∞—Å–∏–≤–∏–π —Ñ–æ–Ω —É –∫–ª—ñ—Ç–∏–Ω–∫—É (–∑–æ—à–∏—Ç) */
            background-color: #fdfcf0;
            background-image: 
                linear-gradient(#e1e8ed 1px, transparent 1px),
                linear-gradient(90deg, #e1e8ed 1px, transparent 1px);
            background-size: 40px 40px;
            font-family: 'Fredoka One', cursive;
            touch-action: none;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: transparent;
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
        }

        /* UI –ï–ª–µ–º–µ–Ω—Ç–∏ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10;
            text-align: center;
            transition: opacity 0.3s;
        }

        h1 { 
            color: #ff4757; 
            font-size: 45px; 
            margin-bottom: 5px; 
            text-shadow: 3px 3px 0px #2f3542; 
            letter-spacing: 2px;
        }
        h2 { color: #535c68; font-size: 22px; margin-bottom: 25px; }
        p { color: #57606f; font-size: 18px; max-width: 85%; line-height: 1.6; background: #fff; padding: 20px; border-radius: 15px; border: 2px dashed #ccc; }

        .btn {
            background: #2ed573;
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 26px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            box-shadow: 0 8px 0 #219d55, 0 15px 20px rgba(0,0,0,0.2);
            transition: all 0.1s;
            margin-top: 25px;
            text-transform: uppercase;
        }
        .btn:active { transform: translateY(8px); box-shadow: 0 0 0 #219d55, inset 0 5px 10px rgba(0,0,0,0.2); }

        /* –í–∏–±—ñ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        .char-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .char-option {
            border: 4px solid #dfe4ea;
            border-radius: 20px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .char-option.selected {
            border-color: #ff4757;
            background: #ffeaa7;
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(255, 71, 87, 0.2);
        }
        .char-img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            margin-bottom: 10px;
            filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.1));
        }
        
        /* HUD –ø—ñ–¥ —á–∞—Å –≥—Ä–∏ */
        #hud {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 10px 20px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 5;
        }
        .hud-text {
            font-size: 28px;
            color: #2f3542;
            background: rgba(255,255,255,0.9);
            padding: 8px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #f1f2f6;
        }
        .hp-bar { color: #ff4757; letter-spacing: 5px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="menuScreen" class="overlay">
        <h1>DOODLE LOVE</h1>
        <h2>–û–±–µ—Ä–∏ —Å–≤–æ–≥–æ –≥–µ—Ä–æ—è:</h2>
        <div class="char-grid">
            <div class="char-option selected" onclick="selectChar('Tito', this)">
                <img id="menuImgTito" class="char-img" src="" alt="Tito">
                <span>Tito</span>
            </div>
            <div class="char-option" onclick="selectChar('Smartik', this)">
                <img id="menuImgSmartik" class="char-img" src="" alt="Smartik">
                <span>Smartik</span>
            </div>
            <div class="char-option" onclick="selectChar('Junior', this)">
                <img id="menuImgJunior" class="char-img" src="" alt="Junior">
                <span>Junior</span>
            </div>
            <div class="char-option" onclick="selectChar('Fil', this)">
                <img id="menuImgFil" class="char-img" src="" alt="Fil">
                <span>Fil</span>
            </div>
        </div>
        <button class="btn" onclick="showInstructions()">–ì–†–ê–¢–ò</button>
    </div>

    <div id="instrScreen" class="overlay hidden">
        <h1>–Ø–ö –ì–†–ê–¢–ò</h1>
        <p>
           üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> –ù–∞—Ö–∏–ª—è–π –≤–ª—ñ–≤–æ/–≤–ø—Ä–∞–≤–æ<br>
           üíª <b>–ü–ö:</b> –°—Ç—Ä—ñ–ª–æ—á–∫–∏ &#8592; —Ç–∞ &#8594;<br><br>
           üöÄ <span style="color:#2ed573">–ó–µ–ª–µ–Ω–∏–π –±—É—Å—Ç</span> - —Å—É–ø–µ—Ä —à–≤–∏–¥–∫—ñ—Å—Ç—å!<br>
           üí£ <span style="color:#2f3542">–ß–æ—Ä–Ω–∞ –¥—ñ—Ä–∞</span> - –º—ñ–Ω—É—Å —Å–µ—Ä–¥–µ—á–∫–æ!<br>
           üç™ <span style="color:#a4b0be">–°—ñ—Ä—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏</span> - –ª–∞–º–∞—é—Ç—å—Å—è!
        </p>
        <button class="btn" onclick="startGame()">–ü–û–ì–ù–ê–õ–ò!</button>
    </div>

    <div id="gameOverScreen" class="overlay hidden">
        <h1 style="color:#2f3542">–û–ô, –í–°–ï!</h1>
        <h2 id="finalScore" style="font-size: 30px; color: #ff4757;">–†–∞—Ö—É–Ω–æ–∫: 0</h2>
        <button class="btn" onclick="location.reload()">–©–ï –†–ê–ó</button>
    </div>

    <div id="hud">
        <div class="hud-text" id="scoreDisplay">0</div>
        <div class="hud-text hp-bar" id="hpDisplay">‚ù§‚ù§‚ù§</div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    // --- –í–ë–£–î–û–í–ê–ù–Ü SVG –ê–°–ï–¢–ò (–©–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–≤–∂–¥–∏ –ø—Ä–∞—Ü—é–≤–∞–ª–∏) ---
    // –Ø –∑–≥–µ–Ω–µ—Ä—É–≤–∞–≤ –ø—Ä–æ—Å—Ç—ñ –≤–µ–∫—Ç–æ—Ä–Ω—ñ –º–∞–ª—é–Ω–∫–∏ –¥–ª—è –≥–µ—Ä–æ—ó–≤ —Ç–∞ –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
    const SVGS = {
        'Tito': `Tito.png`,
        'Smartik': `Smartik.png`,
        'Junior': `Junior.png`,
        'Fil': `Fil.png`,
        'Spring': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><path d="M 10 40 Q 25 10 40 40" fill="none" stroke="%23747d8c" stroke-width="4"/><rect x="5" y="40" width="40" height="5" fill="%232f3542"/></svg>`,
        'Batut': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><ellipse cx="25" cy="35" rx="20" ry="5" fill="%23ff6348" stroke="%232f3542" stroke-width="2"/><line x1="10" y1="35" x2="5" y2="45" stroke="%232f3542" stroke-width="2"/><line x1="40" y1="35" x2="45" y2="45" stroke="%232f3542" stroke-width="2"/></svg>`,
        'Imba': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><polygon points="25,5 31,18 45,18 34,26 38,39 25,31 12,39 16,26 5,18 19,18" fill="%232ed573" stroke="%232f3542" stroke-width="2"/></svg>`,
        'Black': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="black"/><circle cx="25" cy="25" r="18" fill="none" stroke="%23a55eea" stroke-width="2" stroke-dasharray="4"/></svg>`
    };

    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –º–µ–Ω—é
    document.getElementById('menuImgTito').src = SVGS['Tito'];
    document.getElementById('menuImgSmartik').src = SVGS['Smartik'];
    document.getElementById('menuImgJunior').src = SVGS['Junior'];
    document.getElementById('menuImgFil').src = SVGS['Fil'];

    // --- –ó–í–£–ö–û–í–ê –°–ò–°–¢–ï–ú–ê (Web Audio API) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
    }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'jump') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(500, now + 0.1);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
        else if (type === 'spring') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.3);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        }
        else if (type === 'break') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.1);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
        else if (type === 'gameover') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.5);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.5);
            osc.start(now);
            osc.stop(now + 0.5);
        }
    }

    // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –¢–ê –ó–ú–Ü–ù–ù–Ü ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth > 500 ? 480 : window.innerWidth;
    canvas.height = window.innerHeight;

    let gameState = 'MENU';
    let score = 0;
    let selectedCharName = 'Tito';
    let playerHP = 3;

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å –∑ SVGS
    const images = {};
    for (let key in SVGS) {
        let img = new Image();
        img.src = SVGS[key];
        images[key] = img;
    }
    // –î–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º –º–∏ –±—É–¥–µ–º–æ –º–∞–ª—é–≤–∞—Ç–∏ –∫–æ–¥–æ–º –¥–ª—è –∫—Ä–∞—â–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ, –∞–ª–µ –ø—Ä–µ–¥–º–µ—Ç–∏ - –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏

    const player = {
        x: canvas.width / 2 - 25,
        y: canvas.height / 2,
        width: 50,
        height: 50,
        vx: 0,
        vy: 0,
        isImba: false,
        imbaTimer: 0,
        invincible: false
    };

    const gravity = 0.45;
    let platforms = [];
    let items = [];
    let particles = [];
    
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ X –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏, —â–æ–± –Ω–æ–≤–∞ –±—É–ª–∞ –ø–æ—Ä—É—á
    let lastPlatformX = canvas.width / 2; 

    let tiltX = 0;
    let keys = { left: false, right: false };

    // --- –õ–û–ì–Ü–ö–ê –ú–ï–ù–Æ ---
    
    function selectChar(name, el) {
        selectedCharName = name;
        document.querySelectorAll('.char-option').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        initAudio(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞—É–¥—ñ–æ –ø—Ä–∏ –∫–ª—ñ–∫—É
    }

    function showInstructions() {
        document.getElementById('menuScreen').classList.add('hidden');
        document.getElementById('instrScreen').classList.remove('hidden');
        gameState = 'INSTR';
        initAudio();
    }

    function startGame() {
        initAudio();
        // iOS –¥–æ–∑–≤—ñ–ª
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                })
                .catch(console.error);
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }

        document.getElementById('instrScreen').classList.add('hidden');
        document.getElementById('hud').style.display = 'flex';
        gameState = 'GAME';
        resetGame();
        loop();
    }

    // --- –ì–ï–ù–ï–†–ê–¶–Ü–Ø (–ü–û–ö–†–ê–©–ï–ù–ê) ---

    function createPlatform(y) {
        let type = 'normal';
        if (score >= 500 && Math.random() < 0.25) type = 'break';
        else if (score >= 100 && Math.random() < 0.15) type = 'jump';

        // 1. –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –ø–æ–∑–∏—Ü—ñ—ó X (—â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ –¥–æ—Å—Ç—Ä–∏–±–Ω—É—Ç–∏)
        let minX = Math.max(0, lastPlatformX - 250); // –ú–∞–∫—Å —Å—Ç—Ä–∏–±–æ–∫ –≤–ª—ñ–≤–æ
        let maxX = Math.min(canvas.width - 70, lastPlatformX + 250); // –ú–∞–∫—Å —Å—Ç—Ä–∏–±–æ–∫ –≤–ø—Ä–∞–≤–æ
        
        let x = Math.random() * (maxX - minX) + minX;
        
        // –ö–æ—Ä–µ–∫—Ü—ñ—è, —â–æ–± –Ω–µ –≤–∏–ª–∞–∑–∏–ª–æ –∑–∞ –µ–∫—Ä–∞–Ω
        if (x < 0) x = 0;
        if (x > canvas.width - 70) x = canvas.width - 70;

        lastPlatformX = x;

        let p = {
            x: x,
            y: y,
            w: 70, // –¢—Ä–æ—Ö–∏ —à–∏—Ä—à—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ
            h: 18,
            type: type,
            active: true
        };

        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ (—Ç—ñ–ª—å–∫–∏ –Ω–∞ –º—ñ—Ü–Ω–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö)
        if (type !== 'break' && Math.random() < 0.12) {
            let itemType = 'spring';
            let r = Math.random();
            if (r < 0.45) itemType = 'spring';
            else if (r < 0.65) itemType = 'batut';
            else if (r < 0.75) itemType = 'imba';
            else if (r < 0.95) itemType = 'black';

            // –ù–∞–∑–≤–∞ –∫–ª—é—á–∞ –≤ –æ–±'—î–∫—Ç—ñ images
            let imgKey = '';
            if(itemType === 'spring') imgKey = 'Spring';
            if(itemType === 'batut') imgKey = 'Batut';
            if(itemType === 'imba') imgKey = 'Imba';
            if(itemType === 'black') imgKey = 'Black';

            items.push({
                x: p.x + p.w/2 - 15,
                y: p.y - 30,
                w: 30,
                h: 30,
                type: itemType,
                imgKey: imgKey,
                platform: p
            });
        }
        return p;
    }

    function resetGame() {
        score = 0;
        playerHP = 3;
        updateHPDisplay();
        player.y = canvas.height - 150;
        player.x = canvas.width/2 - 25;
        player.vy = -9;
        player.isImba = false;
        lastPlatformX = canvas.width/2;
        
        platforms = [];
        items = [];
        
        // –°—Ç–∞—Ä—Ç–æ–≤—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏ (–±–ª–∏–∂—á–µ –æ–¥–Ω–∞ –¥–æ –æ–¥–Ω–æ—ó)
        // –ö—Ä–æ–∫ 70px –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –º–æ–∂–Ω–∞ –ª–µ–≥–∫–æ –¥–æ—Å—Ç—Ä–∏–±–Ω—É—Ç–∏
        for (let i = canvas.height; i > 0; i -= 70) {
            let p = createPlatform(i);
            p.type = 'normal'; // –ü–µ—Ä—à—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏ –∑–∞–≤–∂–¥–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ñ
            platforms.push(p);
        }
    }

    // --- –û–°–ù–û–í–ù–ò–ô –¶–ò–ö–õ ---

    function loop() {
        if (gameState !== 'GAME') return;
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
        let speed = 7;
        if (player.isImba) speed = 10;
        
        if (keys.left) player.vx = -speed;
        else if (keys.right) player.vx = speed;
        else player.vx = tiltX * speed;

        player.x += player.vx;

        // Wrap –µ–∫—Ä–∞–Ω—É
        if (player.x + player.width < 0) player.x = canvas.width;
        else if (player.x > canvas.width) player.x = -player.width;

        // –§—ñ–∑–∏–∫–∞
        if (player.isImba) {
            player.vy = -18; 
            player.imbaTimer -= 16;
            if (player.imbaTimer <= 0) player.isImba = false;
            // –ï—Ñ–µ–∫—Ç —ñ—Å–∫–æ—Ä
            if(Math.random() < 0.5) {
                particles.push({
                    x: player.x + player.width/2, 
                    y: player.y + player.height, 
                    vy: Math.random() * 3, 
                    life: 20, color: '#2ed573'
                });
            }
        } else {
            player.vy += gravity;
        }
        player.y += player.vy;

        // –†—É—Ö –∫–∞–º–µ—Ä–∏
        if (player.y < canvas.height / 2) {
            let diff = (canvas.height / 2) - player.y;
            player.y = canvas.height / 2;
            
            platforms.forEach(p => {
                p.y += diff;
                if (p.y > canvas.height) {
                    p.remove = true;
                    score++;
                    document.getElementById('scoreDisplay').innerText = score;
                }
            });
            
            items.forEach(i => {
                i.y += diff;
                if (i.y > canvas.height) i.remove = true;
            });
            
            particles.forEach(p => p.y += diff);

            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –Ω–æ–≤–∏—Ö
            let highestPlatformY = Math.min(...platforms.map(p => p.y));
            // –°–ø–∞–≤–Ω–∏–º–æ –Ω–æ–≤—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, —è–∫—â–æ –≤–µ—Ä—Ö–Ω—è –æ–ø—É—Å—Ç–∏–ª–∞—Å—è –Ω–∏–∂—á–µ 70 –ø—ñ–∫—Å–µ–ª—ñ–≤
            if (highestPlatformY > 70) {
                 platforms.push(createPlatform(highestPlatformY - 70));
            }
        }

        platforms = platforms.filter(p => !p.remove);
        items = items.filter(i => !i.remove);

        // –ö–æ–ª—ñ–∑—ñ—ó
        if (player.vy > 0 && !player.isImba) {
            platforms.forEach(p => {
                if (p.active !== false &&
                    player.x + player.width*0.8 > p.x &&
                    player.x + player.width*0.2 < p.x + p.w &&
                    player.y + player.height > p.y &&
                    player.y + player.height < p.y + p.h + player.vy + 2) { // +2 —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω—ñ—Å—Ç—å
                    
                    playSound('jump'); // –ó–≤—É–∫ —Å—Ç—Ä–∏–±–∫–∞

                    if (p.type === 'break') {
                        p.active = false;
                        playSound('break');
                        // –ï—Ñ–µ–∫—Ç –ª–∞–º–∞–Ω–Ω—è
                        for(let k=0; k<5; k++) particles.push({x: p.x+p.w/2, y: p.y, vy: -2, life:30, color:'#a4b0be'});
                    } else if (p.type === 'jump') {
                        player.vy = -16;
                    } else {
                        player.vy = -11.5; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Å—Ç—Ä–∏–±–æ–∫
                    }
                }
            });

            items.forEach(i => {
                if (player.x + player.width > i.x &&
                    player.x < i.x + i.w &&
                    player.y + player.height > i.y &&
                    player.y < i.y + i.h) {
                    
                    if (i.type === 'spring') {
                        player.vy = -20;
                        playSound('spring');
                    } else if (i.type === 'batut') {
                        player.vy = -35;
                        playSound('spring');
                    } else if (i.type === 'imba') {
                        player.isImba = true;
                        player.imbaTimer = 3000;
                        i.remove = true;
                        playSound('spring'); // –∞–±–æ —Å–ø–µ—Ü –∑–≤—É–∫
                    } else if (i.type === 'black') {
                         if (!player.invincible) {
                             playerHP--;
                             updateHPDisplay();
                             i.remove = true;
                             player.vy = -8;
                             player.invincible = true;
                             playSound('break');
                             setTimeout(() => player.invincible = false, 1500);
                         }
                    }
                }
            });
        }

        // –ß–∞—Å—Ç–∏–Ω–∫–∏
        particles.forEach(p => {
            p.y += p.vy;
            p.life--;
        });
        particles = particles.filter(p => p.life > 0);

        // Game Over
        if (playerHP <= 0 || player.y > canvas.height + 100) {
            playSound('gameover');
            gameOver();
        }
    }

    function gameOver() {
        gameState = 'GAMEOVER';
        document.getElementById('hud').style.display = 'none';
        document.getElementById('gameOverScreen').classList.remove('hidden');
        document.getElementById('finalScore').innerText = "–†–∞—Ö—É–Ω–æ–∫: " + score;
    }

    function updateHPDisplay() {
        let hearts = "";
        for(let i=0; i<playerHP; i++) hearts += "‚ù§";
        document.getElementById('hpDisplay').innerText = hearts;
    }

    // --- –ú–ê–õ–Æ–í–ê–ù–ù–Ø ---

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∏ (–ú–∞–ª—é—î–º–æ –∫–æ–¥–æ–º, —â–æ–± –±—É–ª–æ —á—ñ—Ç–∫–æ)
        platforms.forEach(p => {
            if (!p.active && p.type === 'break') return;

            let color = '#2ed573'; // normal
            let border = '#218c74';
            
            if (p.type === 'jump') { color = '#ff4757'; border = '#b33939'; }
            if (p.type === 'break') { color = '#a4b0be'; border = '#747d8c'; }

            // –¢—ñ–Ω—å
            ctx.fillStyle = "rgba(0,0,0,0.1)";
            ctx.fillRect(p.x + 5, p.y + 5, p.w, p.h);

            // –û—Å–Ω–æ–≤–Ω–∞ —Ñ–æ—Ä–º–∞ (–∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω–∞)
            ctx.fillStyle = color;
            ctx.strokeStyle = border;
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.roundRect(p.x, p.y, p.w, p.h, 8);
            ctx.fill();
            ctx.stroke();

            // –ë–ª—ñ–∫
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.fillRect(p.x + 5, p.y + 3, p.w - 10, 4);
        });

        // –ü—Ä–µ–¥–º–µ—Ç–∏
        items.forEach(i => {
            let img = images[i.imgKey];
            if (img && img.complete) {
                ctx.drawImage(img, i.x, i.y, i.w, i.h);
            }
        });

        // –ß–∞—Å—Ç–∏–Ω–∫–∏
        particles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 5, 5);
        });

        // –ì—Ä–∞–≤–µ—Ü—å
        let pImg = images[selectedCharName];
        
        ctx.save();
        // –Ø–∫—â–æ –Ω–µ–≤—Ä–∞–∑–ª–∏–≤–∏–π - –±–ª–∏–º–∞—î
        if (player.invincible) {
            ctx.globalAlpha = 0.5;
        }

        // –ï—Ñ–µ–∫—Ç IMBA (—Å–≤—ñ—Ç—ñ–Ω–Ω—è)
        if (player.isImba) {
            ctx.shadowBlur = 20;
            ctx.shadowColor = "#2ed573";
        }

        // –ü–æ–≤–æ—Ä–æ—Ç –≥—Ä–∞–≤—Ü—è –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ä—É—Ö—É
        if (player.vx > 1) { // –í–ø—Ä–∞–≤–æ
            ctx.translate(player.x + player.width/2, player.y + player.height/2);
            ctx.rotate(0.2); 
            ctx.translate(-(player.x + player.width/2), -(player.y + player.height/2));
        } else if (player.vx < -1) { // –í–ª—ñ–≤–æ
             ctx.translate(player.x + player.width/2, player.y + player.height/2);
             ctx.rotate(-0.2);
             ctx.translate(-(player.x + player.width/2), -(player.y + player.height/2));
        }

        if (pImg && pImg.complete) {
            ctx.drawImage(pImg, player.x, player.y, player.width, player.height);
        }
        ctx.restore();
    }

    // --- –û–ë–†–û–ë–ö–ê –ü–û–î–Ü–ô ---
    window.addEventListener('keydown', e => {
        if (e.code === 'ArrowLeft') keys.left = true;
        if (e.code === 'ArrowRight') keys.right = true;
    });
    window.addEventListener('keyup', e => {
        if (e.code === 'ArrowLeft') keys.left = false;
        if (e.code === 'ArrowRight') keys.right = false;
    });

    function handleOrientation(event) {
        let tilt = event.gamma; 
        if (tilt > 90) tilt = 90;
        if (tilt < -90) tilt = -90;
        tiltX = tilt / 30; // –ß—É—Ç–ª–∏–≤—ñ—Å—Ç—å
        if (tiltX > 1) tiltX = 1;
        if (tiltX < -1) tiltX = -1;
    }

    // –ü–æ–ª—ñ—Ñ—ñ–ª –¥–ª—è roundRect (–¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤)
    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.beginPath();
            this.moveTo(x + r, y);
            this.arcTo(x + w, y, x + w, y + h, r);
            this.arcTo(x + w, y + h, x, y + h, r);
            this.arcTo(x, y + h, x, y, r);
            this.arcTo(x, y, x + w, y, r);
            this.closePath();
            return this;
        };
    }
</script>
</body>
</html>
