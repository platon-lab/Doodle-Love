<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doodle Love: Remastered 2.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* –ö—Ä–∞—Å–∏–≤–∏–π —Ñ–æ–Ω —É –∫–ª—ñ—Ç–∏–Ω–∫—É (–∑–æ—à–∏—Ç) */
            background-color: #fdfcf0;
            background-image: 
                linear-gradient(#e1e8ed 1px, transparent 1px),
                linear-gradient(90deg, #e1e8ed 1px, transparent 1px);
            background-size: 40px 40px;
            font-family: 'Fredoka One', cursive;
            touch-action: none;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: transparent;
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
            cursor: crosshair;
        }

        /* UI –ï–ª–µ–º–µ–Ω—Ç–∏ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10;
            text-align: center;
            transition: opacity 0.3s;
        }

        h1 { 
            color: #ff4757; 
            font-size: 45px; 
            margin-bottom: 5px; 
            text-shadow: 3px 3px 0px #2f3542; 
            letter-spacing: 2px;
        }
        h2 { color: #535c68; font-size: 22px; margin-bottom: 25px; }
        p { color: #57606f; font-size: 16px; max-width: 85%; line-height: 1.5; background: #fff; padding: 15px; border-radius: 15px; border: 2px dashed #ccc; }

        .btn {
            background: #2ed573;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            box-shadow: 0 8px 0 #219d55, 0 15px 20px rgba(0,0,0,0.2);
            transition: all 0.1s;
            margin-top: 15px;
            text-transform: uppercase;
            min-width: 200px;
        }
        .btn:active { transform: translateY(8px); box-shadow: 0 0 0 #219d55, inset 0 5px 10px rgba(0,0,0,0.2); }
        
        .btn-red {
            background: #ff4757;
            box-shadow: 0 8px 0 #b33939, 0 15px 20px rgba(0,0,0,0.2);
        }
        .btn-red:active { box-shadow: 0 0 0 #b33939, inset 0 5px 10px rgba(0,0,0,0.2); }

        .btn-blue {
            background: #54a0ff;
            box-shadow: 0 8px 0 #2e86de, 0 15px 20px rgba(0,0,0,0.2);
        }
        .btn-blue:active { box-shadow: 0 0 0 #2e86de, inset 0 5px 10px rgba(0,0,0,0.2); }

        /* –í–∏–±—ñ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        .char-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .char-option {
            border: 4px solid #dfe4ea;
            border-radius: 20px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .char-option.selected {
            border-color: #ff4757;
            background: #ffeaa7;
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(255, 71, 87, 0.2);
        }
        .char-img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            margin-bottom: 10px;
            filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.1));
        }
        
        /* HUD –ø—ñ–¥ —á–∞—Å –≥—Ä–∏ */
        #hud {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 10px 20px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 5;
        }
        .hud-text {
            font-size: 28px;
            color: #2f3542;
            background: rgba(255,255,255,0.9);
            padding: 8px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #f1f2f6;
        }
        .hp-bar { color: #ff4757; letter-spacing: 5px; }

        /* –ö–Ω–æ–ø–∫–∞ –ü–∞—É–∑–∏ */
        #pauseBtn {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            border: 3px solid #2f3542;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 0 #2f3542;
            z-index: 20;
            pointer-events: auto;
        }
        #pauseBtn:active { transform: translateY(4px); box-shadow: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="menuScreen" class="overlay">
        <h1>DOODLE LOVE</h1>
        <h2>–û–±–µ—Ä–∏ —Å–≤–æ–≥–æ –≥–µ—Ä–æ—è:</h2>
        <div class="char-grid">
            <div class="char-option selected" onclick="selectChar('Tito', this)">
                <img id="menuImgTito" class="char-img" src="" alt="Tito">
                <span>Tito</span>
            </div>
            <div class="char-option" onclick="selectChar('Smartik', this)">
                <img id="menuImgSmartik" class="char-img" src="" alt="Smartik">
                <span>Smartik</span>
            </div>
            <div class="char-option" onclick="selectChar('Junior', this)">
                <img id="menuImgJunior" class="char-img" src="" alt="Junior">
                <span>Junior</span>
            </div>
            <div class="char-option" onclick="selectChar('Fil', this)">
                <img id="menuImgFil" class="char-img" src="" alt="Fil">
                <span>Fil</span>
            </div>
        </div>
        <button class="btn" onclick="showInstructions()">–ì–†–ê–¢–ò</button>
    </div>

    <div id="instrScreen" class="overlay hidden">
        <h1>–Ø–ö –ì–†–ê–¢–ò</h1>
        <p>
           üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> –ù–∞—Ö–∏–ª—è–π –≤–ª—ñ–≤–æ/–≤–ø—Ä–∞–≤–æ<br>
           üíª <b>–ü–ö:</b> –°—Ç—Ä—ñ–ª–æ—á–∫–∏ &#8592; —Ç–∞ &#8594;<br>
           üî´ <b>–ö–ª—ñ–∫:</b> –°–¢–†–Ü–õ–Ø–¢–ò!<br><br>
           üöÄ <b>–ú–ï–ì–ê –ë–£–°–¢:</b> –†—ñ–¥–∫–∞ —Ä–∞–∫–µ—Ç–∞ - —à–∞–ª–µ–Ω–∏–π –ø–æ–ª—ñ—Ç!<br>
           üí£ <b>–ß–æ—Ä–Ω–∞ –¥—ñ—Ä–∞:</b> –°—Ç—Ä—ñ–ª—è–π –≤ –Ω–µ—ó!
        </p>
        <button class="btn" onclick="startGame()">–ü–û–ì–ù–ê–õ–ò!</button>
    </div>

    <div id="pauseScreen" class="overlay hidden">
        <h1>–ü–ê–£–ó–ê</h1>
        <button class="btn" onclick="togglePause()">–ü–†–û–î–û–í–ñ–ò–¢–ò</button>
        <button class="btn btn-red" onclick="resetProgress()">–°–¢–ï–†–¢–ò –ü–†–û–ì–†–ï–°</button>
        <button class="btn btn-blue" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="gameOverScreen" class="overlay hidden">
        <h1 style="color:#2f3542">–û–ô, –í–°–ï!</h1>
        <h2 id="finalScore" style="font-size: 30px; color: #ff4757;">–†–∞—Ö—É–Ω–æ–∫: 0</h2>
        <h2 id="bestScore" style="font-size: 24px; color: #ffa502;">–†–µ–∫–æ—Ä–¥: 0</h2>
        <button class="btn" onclick="startGame()">–©–ï –†–ê–ó</button>
        <button class="btn btn-blue" onclick="location.reload()">–ú–ï–ù–Æ</button>
    </div>

    <div id="hud">
        <div class="hud-text" id="scoreDisplay">0</div>
        <div class="hud-text hp-bar" id="hpDisplay">‚ù§‚ù§‚ù§</div>
    </div>
    
    <div id="pauseBtn" onclick="togglePause()">‚è∏</div>

    <canvas id="gameCanvas"></canvas>

<script>
    // --- –í–ë–£–î–û–í–ê–ù–Ü SVG –ê–°–ï–¢–ò ---
    const SVGS = {
        'Tito': `Tito.png`,
        'Smartik': `Smartik.png`,
        'Junior': `Junior.png`,
        'Fil': `Fil.png`,
        'Spring': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><path d="M 10 40 Q 25 10 40 40" fill="none" stroke="%23747d8c" stroke-width="4"/><rect x="5" y="40" width="40" height="5" fill="%232f3542"/></svg>`,
        'Batut': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><ellipse cx="25" cy="35" rx="20" ry="5" fill="%23ff6348" stroke="%232f3542" stroke-width="2"/><line x1="10" y1="35" x2="5" y2="45" stroke="%232f3542" stroke-width="2"/><line x1="40" y1="35" x2="45" y2="45" stroke="%232f3542" stroke-width="2"/></svg>`,
        'Imba': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><polygon points="25,5 31,18 45,18 34,26 38,39 25,31 12,39 16,26 5,18 19,18" fill="%232ed573" stroke="%232f3542" stroke-width="2"/></svg>`,
        'Rocket': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><path d="M25 5 Q35 25 40 35 L10 35 Q15 25 25 5 Z" fill="%23ff4757" stroke="%232f3542" stroke-width="2"/><rect x="20" y="35" width="10" height="5" fill="%2357606f"/><path d="M20 40 L25 50 L30 40" fill="orange"/></svg>`,
        'Black': `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="black"/><circle cx="25" cy="25" r="18" fill="none" stroke="%23a55eea" stroke-width="2" stroke-dasharray="4"/></svg>`
    };

    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –º–µ–Ω—é
    document.getElementById('menuImgTito').src = SVGS['Tito'];
    document.getElementById('menuImgSmartik').src = SVGS['Smartik'];
    document.getElementById('menuImgJunior').src = SVGS['Junior'];
    document.getElementById('menuImgFil').src = SVGS['Fil'];

    // --- –ó–í–£–ö–û–í–ê –°–ò–°–¢–ï–ú–ê ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
    }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'jump') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(500, now + 0.1);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
        else if (type === 'mega') { // –ó–≤—É–∫ —Ä–∞–∫–µ—Ç–∏
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.linearRampToValueAtTime(800, now + 1.0);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 1.0);
            osc.start(now);
            osc.stop(now + 1.0);
        }
        else if (type === 'shoot') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
        else if (type === 'spring') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.3);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        }
        else if (type === 'break') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.1);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
        else if (type === 'gameover') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.5);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.5);
            osc.start(now);
            osc.stop(now + 0.5);
        }
    }

    // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –¢–ê –ó–ú–Ü–ù–ù–Ü ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth > 500 ? 480 : window.innerWidth;
    canvas.height = window.innerHeight;

    let gameState = 'MENU';
    let score = 0;
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä–µ–∫–æ—Ä–¥ –∑ –ø–∞–º'—è—Ç—ñ
    let highScore = localStorage.getItem('doodleHighScore') ? parseInt(localStorage.getItem('doodleHighScore')) : 0;
    
    let selectedCharName = 'Tito';
    let playerHP = 3;

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
    const images = {};
    for (let key in SVGS) {
        let img = new Image();
        img.src = SVGS[key];
        images[key] = img;
    }

    const player = {
        x: canvas.width / 2 - 25,
        y: canvas.height / 2,
        width: 50,
        height: 50,
        vx: 0,
        vy: 0,
        // –°—Ç–∞—Ç—É—Å–∏
        isImba: false,
        imbaTimer: 0,
        isMega: false, // –ú–ï–ì–ê –ë–£–°–¢
        megaTimer: 0,
        invincible: false,
        // –î–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è
        scaleX: 1,
        scaleY: 1
    };

    const gravity = 0.35;
    const jumpForce = -10;
    
    let platforms = [];
    let items = [];
    let particles = [];
    let bullets = [];
    
    let lastPlatformX = canvas.width / 2; 
    let lastPlatformType = 'normal';

    let tiltX = 0;
    let keys = { left: false, right: false };

    // --- –õ–û–ì–Ü–ö–ê –ú–ï–ù–Æ –¢–ê –ü–ê–£–ó–ò ---
    
    function selectChar(name, el) {
        selectedCharName = name;
        document.querySelectorAll('.char-option').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        initAudio();
    }

    function showInstructions() {
        document.getElementById('menuScreen').classList.add('hidden');
        document.getElementById('instrScreen').classList.remove('hidden');
        gameState = 'INSTR';
        initAudio();
    }

    function togglePause() {
        if (gameState === 'GAME') {
            gameState = 'PAUSE';
            document.getElementById('pauseScreen').classList.remove('hidden');
            document.getElementById('pauseBtn').style.display = 'none';
        } else if (gameState === 'PAUSE') {
            gameState = 'GAME';
            document.getElementById('pauseScreen').classList.add('hidden');
            document.getElementById('pauseBtn').style.display = 'flex';
            loop(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ —Ü–∏–∫–ª
        }
    }

    function resetProgress() {
        if (confirm("–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ–∫–æ—Ä–¥?")) {
            highScore = 0;
            localStorage.setItem('doodleHighScore', 0);
            alert("–ü—Ä–æ–≥—Ä–µ—Å —Å–∫–∏–Ω—É—Ç–æ!");
            togglePause(); // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å —É –≥—Ä—É
        }
    }

    function startGame() {
        initAudio();
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => { if (response === 'granted') window.addEventListener('deviceorientation', handleOrientation); })
                .catch(console.error);
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }

        document.getElementById('instrScreen').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('pauseBtn').style.display = 'flex'; // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –ø–∞—É–∑–∏
        
        gameState = 'GAME';
        resetGame();
        loop();
    }

    // --- –ì–ï–ù–ï–†–ê–¶–Ü–Ø ---

    function createPlatform(y) {
        let type = 'normal';
        let isMoving = false;
        let speed = 0;

        let r = Math.random();

        if (score >= 500 && r < 0.10 && lastPlatformType !== 'break') {
            type = 'break';
        }
        else if (score >= 50 && r < 0.30) {
            type = 'moving';
            isMoving = true;
            speed = (Math.random() * 2) + 1;
        }
        else if (r < 0.45) {
            type = 'onetime';
        }
        else if (score >= 100 && r < 0.55) {
            type = 'jump';
        }

        lastPlatformType = type;

        let minX = Math.max(0, lastPlatformX - 250);
        let maxX = Math.min(canvas.width - 70, lastPlatformX + 250);
        let x = Math.random() * (maxX - minX) + minX;
        if (x < 0) x = 0;
        if (x > canvas.width - 70) x = canvas.width - 70;

        lastPlatformX = x;

        let p = {
            x: x, y: y, w: 70, h: 18,
            type: type, active: true, moving: isMoving, speed: speed,
            dir: Math.random() < 0.5 ? 1 : -1
        };

        if (type === 'normal' || type === 'moving') {
            if (Math.random() < 0.12) {
                let itemType = 'spring';
                let ir = Math.random();
                
                // –®–∞–Ω—Å–∏ —Å–ø–∞–≤–Ω—É –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                if (ir < 0.40) itemType = 'spring';
                else if (ir < 0.60) itemType = 'batut';
                else if (ir < 0.70) itemType = 'imba';
                else if (ir < 0.90) itemType = 'black';
                else if (ir < 0.95) itemType = 'mega'; // 5% —à–∞–Ω—Å –Ω–∞ –ú–ï–ì–ê –†–ê–ö–ï–¢–£

                let imgKey = '';
                if(itemType === 'spring') imgKey = 'Spring';
                if(itemType === 'batut') imgKey = 'Batut';
                if(itemType === 'imba') imgKey = 'Imba';
                if(itemType === 'mega') imgKey = 'Rocket';
                if(itemType === 'black') imgKey = 'Black';

                items.push({
                    x: p.x + p.w/2 - 15,
                    y: p.y - 30,
                    w: 30, h: 30,
                    type: itemType,
                    imgKey: imgKey,
                    platform: p
                });
            }
        }
        return p;
    }

    function resetGame() {
        score = 0;
        playerHP = 3;
        updateHPDisplay();
        player.y = canvas.height - 150;
        player.x = canvas.width/2 - 25;
        player.vy = -9;
        player.isImba = false;
        player.isMega = false;
        player.scaleX = 1; 
        player.scaleY = 1;
        
        lastPlatformX = canvas.width/2;
        lastPlatformType = 'normal';
        
        platforms = [];
        items = [];
        bullets = [];
        
        for (let i = canvas.height; i > 0; i -= 70) {
            let p = createPlatform(i);
            p.type = 'normal';
            p.moving = false;
            platforms.push(p);
        }
    }

    // --- –û–°–ù–û–í–ù–ò–ô –¶–ò–ö–õ ---

    function loop() {
        if (gameState !== 'GAME') return; // –Ø–∫—â–æ –ø–∞—É–∑–∞ –∞–±–æ –º–µ–Ω—é, —Ü–∏–∫–ª –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        let speed = 6;
        if (player.isImba) speed = 9;
        if (player.isMega) speed = 12; // –©–µ —à–≤–∏–¥—à–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –º–µ–≥–∞ –±—É—Å—Ç—É
        
        if (keys.left) player.vx = -speed;
        else if (keys.right) player.vx = speed;
        else player.vx = tiltX * speed;

        player.x += player.vx;

        if (player.x + player.width < 0) player.x = canvas.width;
        else if (player.x > canvas.width) player.x = -player.width;

        platforms.forEach(p => {
            if (p.moving) {
                p.x += p.speed * p.dir;
                if (p.x <= 0 || p.x + p.w >= canvas.width) p.dir *= -1;
            }
        });

        items.forEach(i => {
            if (i.platform && i.platform.moving) {
                i.x += i.platform.speed * i.platform.dir;
            }
        });

        // --- –§–Ü–ó–ò–ö–ê –ì–†–ê–í–¶–Ø ---
        
        // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ (–µ–ª–∞—Å—Ç–∏—á–Ω—ñ—Å—Ç—å)
        player.scaleX += (1 - player.scaleX) * 0.15;
        player.scaleY += (1 - player.scaleY) * 0.15;

        // –õ–û–ì–Ü–ö–ê –ú–ï–ì–ê –£–õ–¨–¢–†–ê –ë–£–°–¢–£
        if (player.isMega) {
            player.vy = -30; // –ù–ï–†–ï–ê–õ–¨–ù–ê –®–í–ò–î–ö–Ü–°–¢–¨ –í–ì–û–†–£
            player.megaTimer -= 16;
            player.invincible = true; // –ë–µ–∑—Å–º–µ—Ä—Ç—è
            
            // –í–æ–≥–æ–Ω—å –∑ –¥—É–ø–∏
            for(let k=0; k<2; k++) {
                particles.push({
                    x: player.x + player.width/2 + (Math.random()-0.5)*20, 
                    y: player.y + player.height, 
                    vy: Math.random() * 5 + 5, 
                    life: 15, color: k%2==0 ? '#ff4757' : '#ffa502'
                });
            }

            if (player.megaTimer <= 0) {
                player.isMega = false;
                player.invincible = false;
                player.vy = -10; // –¢—Ä–æ—Ö–∏ –ø—ñ–¥–∫–∏–Ω—É—Ç–∏ –Ω–∞ –≤–∏—Ö–æ–¥—ñ
            }
        } 
        else if (player.isImba) {
            player.vy = -15; 
            player.imbaTimer -= 16;
            if (player.imbaTimer <= 0) player.isImba = false;
            if(Math.random() < 0.5) {
                particles.push({
                    x: player.x + player.width/2, 
                    y: player.y + player.height, 
                    vy: Math.random() * 3, 
                    life: 20, color: '#2ed573'
                });
            }
        } else {
            player.vy += gravity;
        }
        
        player.y += player.vy;

        // –†—É—Ö –∫–∞–º–µ—Ä–∏
        if (player.y < canvas.height / 2) {
            let diff = (canvas.height / 2) - player.y;
            player.y = canvas.height / 2;
            
            platforms.forEach(p => {
                p.y += diff;
                if (p.y > canvas.height) {
                    p.remove = true;
                    score += 3;
                    document.getElementById('scoreDisplay').innerText = score;
                }
            });
            
            items.forEach(i => {
                i.y += diff;
                if (i.y > canvas.height) i.remove = true;
            });

            bullets.forEach(b => b.y += diff);
            particles.forEach(p => p.y += diff);

            let highestPlatformY = Math.min(...platforms.map(p => p.y));
            if (highestPlatformY > 70) {
                 platforms.push(createPlatform(highestPlatformY - 70));
            }
        }

        bullets.forEach(b => {
            b.y += b.vy;
            if (b.y < -50) b.remove = true;
            
            items.forEach(i => {
                if (i.type === 'black' && !i.remove && !b.remove) {
                    let dx = b.x - (i.x + i.w/2);
                    let dy = b.y - (i.y + i.h/2);
                    if (Math.sqrt(dx*dx + dy*dy) < 30) {
                        i.remove = true;
                        b.remove = true;
                        playSound('break');
                        for(let k=0; k<10; k++) {
                            particles.push({
                                x: i.x+i.w/2, y: i.y+i.h/2, 
                                vy: (Math.random()-0.5)*10, vx: (Math.random()-0.5)*10,
                                life:20, color:'#a55eea'
                            });
                        }
                    }
                }
            });
        });

        platforms = platforms.filter(p => !p.remove);
        items = items.filter(i => !i.remove);
        bullets = bullets.filter(b => !b.remove);

        // –ö–æ–ª—ñ–∑—ñ—ó
        if (player.vy > 0 && !player.isImba && !player.isMega) {
            platforms.forEach(p => {
                if (p.active !== false &&
                    player.x + player.width*0.8 > p.x &&
                    player.x + player.width*0.2 < p.x + p.w &&
                    player.y + player.height > p.y &&
                    player.y + player.height < p.y + p.h + player.vy + 2) {
                    
                    playSound('jump');

                    // –ï–§–ï–ö–¢ –ü–õ–Æ–©–ï–ù–ù–Ø (Squash)
                    player.scaleX = 1.3;
                    player.scaleY = 0.7;

                    if (p.type === 'break') {
                        p.active = false;
                        playSound('break');
                        for(let k=0; k<5; k++) particles.push({x: p.x+p.w/2, y: p.y, vy: -2, life:30, color:'#a4b0be'});
                    } 
                    else if (p.type === 'jump') {
                        player.vy = jumpForce * 1.5;
                    }
                    else if (p.type === 'onetime') {
                        player.vy = jumpForce;
                        p.remove = true; 
                        for(let k=0; k<5; k++) particles.push({x: p.x+p.w/2, y: p.y, vy: -1, life:20, color:'#fd79a8'});
                    }
                    else {
                        player.vy = jumpForce;
                    }
                }
            });

            items.forEach(i => {
                if (player.x + player.width > i.x &&
                    player.x < i.x + i.w &&
                    player.y + player.height > i.y &&
                    player.y < i.y + i.h) {
                    
                    if (i.type === 'spring') {
                        player.vy = -18;
                        playSound('spring');
                    } else if (i.type === 'batut') {
                        player.vy = -28;
                        playSound('spring');
                    } else if (i.type === 'imba') {
                        player.isImba = true;
                        player.imbaTimer = 3000;
                        i.remove = true;
                        playSound('spring');
                    } else if (i.type === 'mega') { // –ü–Ü–î–ë–Ü–† –†–ê–ö–ï–¢–ò
                        player.isMega = true;
                        player.megaTimer = 5000; // 5 –°–µ–∫—É–Ω–¥
                        i.remove = true;
                        playSound('mega');
                    } else if (i.type === 'black') {
                         if (!player.invincible) {
                             playerHP--;
                             updateHPDisplay();
                             i.remove = true;
                             player.vy = -5;
                             player.invincible = true;
                             playSound('break');
                             setTimeout(() => player.invincible = false, 1500);
                         }
                    }
                }
            });
        }

        particles.forEach(p => {
            p.y += p.vy;
            if(p.vx) p.x += p.vx;
            p.life--;
        });
        particles = particles.filter(p => p.life > 0);

        if (playerHP <= 0 || player.y > canvas.height + 100) {
            playSound('gameover');
            gameOver();
        }
    }

    function gameOver() {
        gameState = 'GAMEOVER';
        document.getElementById('hud').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'none';
        document.getElementById('gameOverScreen').classList.remove('hidden');
        
        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∫–æ—Ä–¥—É
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('doodleHighScore', highScore);
        }

        document.getElementById('finalScore').innerText = "–†–∞—Ö—É–Ω–æ–∫: " + score;
        document.getElementById('bestScore').innerText = "–†–µ–∫–æ—Ä–¥: " + highScore;
    }

    function updateHPDisplay() {
        let hearts = "";
        for(let i=0; i<playerHP; i++) hearts += "‚ù§";
        document.getElementById('hpDisplay').innerText = hearts;
    }

    // --- –ú–ê–õ–Æ–í–ê–ù–ù–Ø ---

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        platforms.forEach(p => {
            if (!p.active && p.type === 'break') return;

            let color = '#2ed573';
            let border = '#218c74';
            
            if (p.type === 'jump') { color = '#ff4757'; border = '#b33939'; }
            if (p.type === 'break') { color = '#a4b0be'; border = '#747d8c'; }
            if (p.type === 'moving') { color = '#54a0ff'; border = '#2e86de'; }
            if (p.type === 'onetime') { color = '#fd79a8'; border = '#e84393'; }

            ctx.fillStyle = "rgba(0,0,0,0.1)";
            ctx.fillRect(p.x + 5, p.y + 5, p.w, p.h);

            ctx.fillStyle = color;
            ctx.strokeStyle = border;
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.roundRect(p.x, p.y, p.w, p.h, 8);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.fillRect(p.x + 5, p.y + 3, p.w - 10, 4);

            if (p.type === 'onetime') {
                ctx.fillStyle = "rgba(255,255,255,0.5)";
                ctx.fillRect(p.x + 15, p.y + 5, 5, 8);
                ctx.fillRect(p.x + 30, p.y + 5, 5, 8);
                ctx.fillRect(p.x + 45, p.y + 5, 5, 8);
            }
        });

        items.forEach(i => {
            let img = images[i.imgKey];
            if (img && img.complete) {
                // –ü—É–ª—å—Å–∞—Ü—ñ—è –¥–ª—è –º–µ–≥–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
                if (i.type === 'mega') {
                    ctx.save();
                    let scale = 1 + Math.sin(Date.now() / 100) * 0.1;
                    ctx.translate(i.x + i.w/2, i.y + i.h/2);
                    ctx.scale(scale, scale);
                    ctx.drawImage(img, -i.w/2, -i.h/2, i.w, i.h);
                    ctx.restore();
                } else {
                    ctx.drawImage(img, i.x, i.y, i.w, i.h);
                }
            }
        });

        bullets.forEach(b => {
            ctx.beginPath();
            ctx.arc(b.x, b.y, 6, 0, Math.PI * 2);
            ctx.fillStyle = '#ffa502';
            ctx.fill();
            ctx.strokeStyle = '#ff6348';
            ctx.stroke();
        });

        particles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 5, 5);
        });

        // –ì—Ä–∞–≤–µ—Ü—å
        let pImg = images[selectedCharName];
        
        ctx.save();
        
        // –¶–µ–Ω—Ç—Ä—É—î–º–æ —Å–∏—Å—Ç–µ–º—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ –≥—Ä–∞–≤—Ü–µ–≤—ñ –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ–π
        ctx.translate(player.x + player.width/2, player.y + player.height/2);

        if (player.invincible) {
            ctx.globalAlpha = 0.5;
        }

        if (player.isImba) {
            ctx.shadowBlur = 20;
            ctx.shadowColor = "#2ed573";
        }
        
        if (player.isMega) {
            ctx.shadowBlur = 30;
            ctx.shadowColor = "#ff4757";
        }

        // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è (Squash)
        ctx.scale(player.scaleX, player.scaleY);

        // –ü–æ–≤–æ—Ä–æ—Ç –≤—ñ–¥ —Ä—É—Ö—É
        if (player.vx > 1) {
            ctx.rotate(0.2); 
        } else if (player.vx < -1) {
             ctx.rotate(-0.2);
        }

        // –ú–∞–ª—é—î–º–æ –≥—Ä–∞–≤—Ü—è (–≤—ñ–¥—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–æ)
        if (pImg && pImg.complete) {
            ctx.drawImage(pImg, -player.width/2, -player.height/2, player.width, player.height);
        }
        ctx.restore();
    }

    // --- –û–ë–†–û–ë–ö–ê –ü–û–î–Ü–ô ---
    window.addEventListener('keydown', e => {
        if (e.code === 'ArrowLeft') keys.left = true;
        if (e.code === 'ArrowRight') keys.right = true;
        if (e.code === 'Escape') togglePause(); // –ü–∞—É–∑–∞ –Ω–∞ ESC
    });
    window.addEventListener('keyup', e => {
        if (e.code === 'ArrowLeft') keys.left = false;
        if (e.code === 'ArrowRight') keys.right = false;
    });

    window.addEventListener('pointerdown', (e) => {
        // –°—Ç—Ä—ñ–ª—è—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≥—Ä–∞, —ñ –Ω–µ –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ –∫–Ω–æ–ø–∫—É —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        if (gameState === 'GAME' && e.target.id !== 'pauseBtn' && e.target.tagName !== 'BUTTON') {
            bullets.push({
                x: player.x + player.width/2,
                y: player.y,
                vy: -15
            });
            playSound('shoot');
        }
    });

    function handleOrientation(event) {
        let tilt = event.gamma; 
        if (tilt > 90) tilt = 90;
        if (tilt < -90) tilt = -90;
        tiltX = tilt / 30; 
        if (tiltX > 1) tiltX = 1;
        if (tiltX < -1) tiltX = -1;
    }

    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.beginPath();
            this.moveTo(x + r, y);
            this.arcTo(x + w, y, x + w, y + h, r);
            this.arcTo(x + w, y + h, x, y + h, r);
            this.arcTo(x, y + h, x, y, r);
            this.arcTo(x, y, x + w, y, r);
            this.closePath();
            return this;
        };
    }
</script>
</body>
</html>
